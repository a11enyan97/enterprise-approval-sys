# 企业级审批系统 API 文档

> 最后更新：2025-11-27  
> 所有接口基于 Next.js Route Handler，默认返回 `application/json`。

## 基础信息

- **Base URL**：`/api`
- **认证方式**：当前版本未实现鉴权，默认所有接口均可访问。后续可在 `app/api/_shared` 中扩展中间件。
- **时间格式**：服务端统一使用 ISO 8601 字符串（UTC），示例：`2025-11-27T08:00:00.000Z`
- **大整数**：由于 Prisma 模型存在 `BigInt` 字段，返回前会通过 `serialize()` 转为字符串。

## 响应规范

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `success` | boolean | 是否成功 |
| `data` | any | 成功时返回的数据 |
| `error` | string | 失败时的用户可读错误信息 |
| `code` | string | 失败时的业务错误码（可选） |
| `field` / `details` | string | 失败时的字段定位与补充说明（可选） |

### 错误结构示例

```
{
  "success": false,
  "error": "审批申请状态为 pending，只有 draft 状态的申请可以修改",
  "code": "INVALID_STATUS",
  "field": "currentStatus"
}
```

内置错误码来源：`app/api/_shared/errors.ts` 与 `app/api/_shared/validators.ts`。

## 公共数据模型

### 审批状态枚举

| 状态值 | 说明 | 流转来源 |
| --- | --- | --- |
| `draft` | 草稿 | 新建后默认状态 |
| `pending` | 待审批 | 申请人提交（PUT currentStatus） |
| `approved` | 已通过 | 审批人通过（PATCH action=approve） |
| `rejected` | 已拒绝 | 审批人拒绝（PATCH action=reject） |

### `ApprovalRequest` 关键字段

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` | string(BigInt) | 审批申请主键 |
| `requestNo` | string | 系统生成的单号（`APP${timestamp}`） |
| `projectName` | string | 审批项目名称 |
| `approvalContent` | string? | 审批内容（≤300字） |
| `deptFullPath` | string? | 部门全路径，例如 `总部/研发部/AI组` |
| `deptLevel{1,2,3}Id` | number? | 对应层级的部门 ID |
| `executeDate` | string | 执行日期 |
| `currentStatus` | string | 参考“审批状态枚举” |
| `applicantId` | number | 申请人 ID |
| `applicant` | `{ id, realName }` | 申请人信息 |
| `attachments` | `ApprovalAttachment[]` | 附件列表（详情见 `types/approval.ts`） |
| `submittedAt` / `completedAt` | string? | 提交/完成时间 |

## 接口列表

### 1. 创建审批申请

- **Endpoint**：`POST /api/approval`
- **权限**：申请人
- **请求体**

| 字段 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| `projectName` | string | ✓ | 审批项目名称 |
| `approvalContent` | string |  | 审批内容 |
| `deptFullPath` | string |  | 部门全路径（冗余展示字段） |
| `deptLevel1Id` | number |  | 一级部门 ID |
| `deptLevel2Id` | number |  | 二级部门 ID |
| `deptLevel3Id` | number |  | 三级部门 ID |
| `executeDate` | string \| Date | ✓ | 执行日期 |
| `applicantId` | number | ✓ | 申请人 ID（存在性校验） |

> 系统会自动创建单号 `requestNo`，返回体包含 `applicant` 关系字段。

**成功响应**

```
{
  "success": true,
  "data": {
    "id": "1",
    "requestNo": "APP1732690885000",
    "projectName": "AI 服务器采购",
    "currentStatus": "draft",
    "applicant": { "id": 3, "realName": "张三" },
    "...": "..."
  }
}
```

### 2. 获取审批申请列表

- **Endpoint**：`GET /api/approval`
- **查询参数**

| 参数 | 类型 | 默认 | 说明 |
| --- | --- | --- | --- |
| `page` | number | 1 | 页码（≥1） |
| `pageSize` | number | 10 | 每页数量 |
| `applicantId` | number |  | 按申请人过滤 |
| `status` | string |  | 按状态过滤 |
| `deptLevel1Id` | number |  | 一级部门过滤 |
| `deptLevel2Id` | number |  | 二级部门过滤（优先级高于一级） |
| `deptLevel3Id` | number |  | 三级部门过滤（优先级最高） |

**成功响应**

```
{
  "success": true,
  "data": {
    "data": [/* ApprovalRequestItem[] */],
    "total": 35,
    "page": 1,
    "pageSize": 10,
    "totalPages": 4
  }
}
```

### 3. 获取审批申请详情

- **Endpoint**：`GET /api/approval/{requestId}`
- **路径参数**

| 参数 | 说明 |
| --- | --- |
| `requestId` | 审批申请 BigInt 主键 |

**可能的 404 响应**

```
{
  "success": false,
  "error": "审批申请不存在",
  "code": "NOT_FOUND"
}
```

### 4. 更新/提交审批申请

- **Endpoint**：`PUT /api/approval/{requestId}`
- **使用场景**
  - **编辑草稿**：当请求体不包含 `currentStatus` 时，可更新项包括：`projectName`、`approvalContent`、`deptFullPath`、`deptLevel{1,2,3}Id`、`executeDate`。仅 `draft` 状态允许编辑。
  - **提交草稿**：当请求体包含 `currentStatus: "pending"` 时，仅更新状态，同时自动写入 `submittedAt`。只有 `draft` 可提交。
  - **标记完成**：当 `currentStatus` 设置为 `approved` 或 `rejected` 时会自动写入 `completedAt`（一般建议通过 PATCH 完成审批流程，但服务端已兼容）。

**请求体验例（提交草稿）**

```
{
  "currentStatus": "pending"
}
```

**成功响应**：返回更新后的 `ApprovalRequest`。

### 5. 审批操作（同意/拒绝）

- **Endpoint**：`PATCH /api/approval/{requestId}`
- **请求体**

| 字段 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| `action` | `"approve"` \| `"reject"` | ✓ | 审批动作 |
| `approverId` | number | ✓ | 审批人 ID（存在性校验） |

- **约束**
  - 仅 `pending` 状态可执行。
  - 系统会将 `currentStatus` 更新为 `approved` 或 `rejected`，并写入 `completedAt`。

**失败示例（缺参数）**

```
{
  "success": false,
  "error": "缺少必要参数 approverId",
  "code": "MISSING_PARAMETER"
}
```

### 6. 删除审批申请

- **Endpoint**：`DELETE /api/approval/{requestId}`
- **说明**
  - 删除目标审批单及其关联附件（事务处理）。
  - 返回被删除记录的快照（含附件信息），便于前端做回显提醒。

### 7. 获取部门级联数据

- **Endpoint**：`GET /api/departments`
- **查询参数**

| 参数 | 默认 | 说明 |
| --- | --- | --- |
| `format` | `cascader` | `cascader`：返回 TreeSelect 需要的 `{ title, key, children }` 结构；`list`：返回完整部门树（含 level、sortOrder 等原始字段）。 |

- **业务逻辑**
  - 仅返回 `status = 1` 的启用部门。
  - 结果已按 `level`、`sortOrder`、`id` 排序。

**响应示例（`format=cascader`）**

```
{
  "success": true,
  "data": [
    {
      "title": "总部",
      "key": "1",
      "children": [
        {
          "title": "研发部",
          "key": "2",
          "children": [
            { "title": "AI 组", "key": "3" }
          ]
        }
      ]
    }
  ]
}
```

## 附录

- **数据校验**：所有涉及用户与部门的接口均通过 `validateUserExists()`、`validateDepartments()` 检查外键有效性，返回 `USER_NOT_FOUND` / `DEPARTMENT_NOT_FOUND` 等错误码。
- **扩展建议**：若需要文件上传、审批流配置、权限控制，可分别在 `app/api/template`、`prisma` 模式与中间件中扩展。


