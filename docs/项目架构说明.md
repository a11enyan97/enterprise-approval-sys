# 项目架构说明

## 项目概述

企业审批系统（Enterprise Approval System）是一个基于 **Next.js 16 App Router** 构建的全栈应用，采用 **Server Components**、**Server Actions** 和 **Prisma ORM** 的现代化架构。

## 技术栈

- **框架**: Next.js 16.0.3 (App Router)
- **UI 库**: ArcoDesign 2.66.8
- **数据库**: MySQL(通过 Prisma ORM)
- **状态管理**: Zustand 5.0.8
- **类型系统**: TypeScript 5
- **样式**: Tailwind CSS 4
- **文件存储**: 阿里云 OSS

## 项目结构

```
enterprise-approval-sys/
├── app/                          # Next.js App Router 目录
│   ├── layout.tsx               # 根布局（全局 Header、Sider）
│   ├── page.tsx                 # 首页
│   └── approval/                # 审批模块路由
│       ├── page.tsx             # 审批列表页（Server Component）
│       └── info/
│           └── [pageType]/      # 动态路由：add/edit/details
│               └── page.tsx     # 审批详情/编辑页（Server Component）
│
├── components/                   # React 组件
│   ├── common/                  # 通用组件
│   │   └── LayoutClient.tsx    # 全局布局客户端组件（Header、Sider）
│   └── business/                # 业务组件
│       ├── approval/            # 审批相关组件
│       │   ├── ApprovalTableClient.tsx    # 审批表格（Client Component）
│       │   ├── ApprovalFilterClient.tsx   # 筛选器（Client Component）
│       │   ├── ApprovalDetailClient.tsx   # 详情/编辑表单（Client Component）
│       │   ├── ApprovalFormClient.tsx     # 表单组件
│       │   └── TableColumn.tsx            # 表格列配置（包含 JSX）
│       ├── CollapsibleFilter.tsx          # 可折叠筛选器
│       └── ConfirmModal.tsx                # 确认弹窗
│
├── services/                     # 业务逻辑层（Service Layer）
│   ├── _shared/                  # 共享工具
│   │   ├── errors.ts           # 错误处理
│   │   ├── utils.ts            # 工具函数（序列化等）
│   │   └── validators.ts       # 数据验证器
│   ├── entities/                # 实体转换层
│   │   ├── ApprovalRequest.entity.ts
│   │   ├── ApprovalAttachment.entity.ts
│   │   ├── Department.entity.ts
│   │   ├── User.entity.ts
│   │   └── UserDepartment.entity.ts
│   ├── approval.service.ts      # 审批业务逻辑
│   ├── departments.service.ts   # 部门业务逻辑
│   └── oss.service.ts          # OSS 文件服务
│
├── actions/                      # Server Actions（数据变更操作）
│   ├── approval.action.ts       # 审批相关 Server Actions
│   ├── departments.action.ts    # 部门相关 Server Actions
│   └── oss.action.ts            # OSS 相关 Server Actions
│
├── prisma/                       # 数据库层
│   ├── schema.prisma            # Prisma 数据模型定义
│   ├── db.ts                    # Prisma Client 初始化
│   ├── migrations/              # 数据库迁移文件
│   └── prisma.config.ts         # Prisma 配置
│
├── types/                        # TypeScript 类型定义
│   ├── approval.ts             # 审批相关类型
│   ├── departments.ts           # 部门相关类型
│   └── oss.ts                  # OSS 相关类型
│
├── constants/                    # 常量配置
│   └── approval.ts             # 审批状态选项、映射等
│
├── utils/                        # 工具函数（纯函数，无 JSX）
│   ├── approval.ts             # 审批工具函数（getStatusLabel）
│   ├── format.ts               # 格式化工具（formatDateTime）
│   └── client-upload.ts        # 客户端文件上传工具
│
├── store/                        # 状态管理（Zustand）
│   └── userStore.ts           # 用户状态管理
│
└── generated/                    # 生成的文件
    └── prisma/                  # Prisma Client 生成代码
```

## 架构设计原则

### 1. Next.js App Router 架构

项目严格遵循 Next.js App Router 的最佳实践：

- **Server Components 优先**: 默认使用 Server Components，只在需要交互时使用 Client Components
- **数据获取**: 在 Server Components 中直接调用 Service 层获取数据
- **数据变更**: 使用 Server Actions 处理表单提交和数据变更
- **无 API Routes**: 不使用 `pages/api` 或 `app/api`，直接使用 Server Actions

### 2. 分层架构

```
┌─────────────────────────────────────┐
│   Presentation Layer (UI)           │
│   - Server Components (pages)        │
│   - Client Components (interactive)  │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Action Layer (Server Actions)     │
│   - 数据变更操作（POST/PUT/DELETE） │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Service Layer (Business Logic)    │
│   - 业务逻辑处理                     │
│   - 数据验证                         │
│   - 实体转换                         │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Data Access Layer (Prisma)         │
│   - 数据库操作                       │
│   - ORM 映射                         │
└─────────────────────────────────────┘
```

### 3. 文件组织原则

#### Server Components (`app/`)
- **职责**: 数据获取、初始渲染
- **特点**: 可以直接调用 Service 层，不能使用 Hooks 和浏览器 API

#### Client Components (`components/`)
- **职责**: 交互逻辑、事件处理
- **特点**: 必须使用 `"use client"` 指令，可以使用 Hooks

#### Server Actions (`actions/`)
- **职责**: 处理数据变更（创建、更新、删除）
- **特点**: 必须使用 `"use server"` 指令，只能从 Client Components 调用

#### Service Layer (`services/`)
- **职责**: 业务逻辑、数据验证、实体转换
- **特点**: 纯函数，无副作用（除了数据库操作），可被 Server Components 和 Server Actions 调用

#### Utils (`utils/`)
- **职责**: 纯工具函数
- **特点**: 无 JSX、无组件依赖、可复用

#### Constants (`constants/`)
- **职责**: 静态配置数据
- **特点**: 纯数据，无逻辑、无组件依赖

## 数据流

### 1. 数据获取流程（GET）

```
用户访问页面
    ↓
Server Component (app/approval/page.tsx)
    ↓
直接调用 Service (services/approval.service.ts)
    ↓
Prisma 查询数据库
    ↓
返回数据给 Server Component
    ↓
渲染 Client Components（传递 initialData）
```

**示例**:
```typescript
// app/approval/page.tsx (Server Component)
export default async function ApprovalPage({ searchParams }) {
  // 直接在 Server Component 中获取数据
  const approvalData = await getApprovalRequestList(queryOptions);
  const departmentOptions = await getDepartmentCascaderOptions();
  
  return (
    <ApprovalTableClient initialData={approvalData} />
  );
}
```

### 2. 数据变更流程（POST/PUT/DELETE）

```
用户交互（表单提交、按钮点击）
    ↓
Client Component 调用 Server Action
    ↓
Server Action (actions/approval.action.ts)
    ↓
调用 Service 层处理业务逻辑
    ↓
Prisma 更新数据库
    ↓
返回结果给 Client Component
    ↓
更新 UI（router.refresh()）
```

**示例**:
```typescript
// actions/approval.action.ts (Server Action)
"use server";
export async function submitApprovalAction(id: string) {
  const result = await submitApprovalRequest(id);
  return { success: true, data: result };
}

// components/.../ApprovalTableClient.tsx (Client Component)
const handleSubmit = async (record) => {
  const result = await submitApprovalAction(record.id);
  if (result.success) {
    router.refresh(); // 刷新 Server Component
  }
};
```

## 核心模块说明

### 1. 审批模块 (`app/approval/`)

#### 页面结构
- **列表页** (`page.tsx`): Server Component，获取初始数据
- **详情/编辑页** (`info/[pageType]/page.tsx`): Server Component，根据 `pageType` 显示不同视图

#### 组件职责
- `ApprovalTableClient`: 表格展示、分页、操作按钮
- `ApprovalFilterClient`: 筛选条件、URL 参数同步
- `ApprovalDetailClient`: 详情查看、编辑表单、文件上传

### 2. Service 层 (`services/`)

#### 职责划分
- **业务逻辑**: 数据验证、业务规则处理
- **实体转换**: Prisma 模型 ↔ 业务实体
- **数据查询**: 复杂查询逻辑封装

#### 共享工具 (`_shared/`)
- `errors.ts`: 统一错误处理
- `validators.ts`: 数据验证（用户存在性、部门有效性等）
- `utils.ts`: 序列化工具（处理 BigInt、Date 等）

### 3. Server Actions (`actions/`)

#### 设计原则
- 所有数据变更操作都通过 Server Actions
- 统一的错误处理格式：`{ success: boolean, data?: T, error?: string }`
- 使用 discriminated union 类型确保类型安全

### 4. 状态管理 (`store/`)

#### Zustand Store
- `userStore.ts`: 用户信息、角色管理
- 使用 `persist` 中间件持久化到 localStorage
- 提供角色切换功能（申请者/审批者）

### 5. 类型系统 (`types/`)

#### 类型定义
- 业务实体类型（`ApprovalRequestItem`、`Department` 等）
- API 请求/响应类型
- 枚举类型（`ApprovalStatus`、`UserRole`）

## 最佳实践

### 1. 组件设计

**Server Component vs Client Component**
- ✅ Server Component: 数据获取、静态内容
- ✅ Client Component: 交互逻辑、事件处理、Hooks

**示例**:
```typescript
// ✅ Server Component - 获取数据
export default async function Page() {
  const data = await getData();
  return <ClientComponent initialData={data} />;
}

// ✅ Client Component - 处理交互
"use client";
export default function ClientComponent({ initialData }) {
  const [data, setData] = useState(initialData);
  // ... 交互逻辑
}
```

### 2. 数据获取

**原则**: 在 Server Component 中直接调用 Service，不使用自定义 Hooks

```typescript
// ✅ 正确：Server Component 直接调用 Service
export default async function Page() {
  const data = await getApprovalRequestList(params);
  return <Table data={data} />;
}

// ❌ 错误：不要在 Server Component 中使用 Hooks
export default function Page() {
  const { data } = useApprovalList(); // ❌
}
```

### 3. 数据变更

**原则**: 使用 Server Actions，不使用 API Routes

```typescript
// ✅ 正确：使用 Server Action
"use server";
export async function submitAction(id: string) {
  return await submitService(id);
}

// ❌ 错误：不要使用 API Routes
// app/api/approval/route.ts ❌
```

### 4. 文件组织

**配置 vs 工具 vs 组件**
- `constants/`: 纯配置数据（状态选项、映射表）
- `utils/`: 纯工具函数（无 JSX、无组件依赖）
- `components/`: 包含 JSX 或组件依赖的代码

**示例**:
```typescript
// ✅ constants/approval.ts - 纯配置
export const APPROVAL_STATUS_OPTIONS = [...] as const;

// ✅ utils/approval.ts - 纯函数
export function getStatusLabel(status: string): string { ... }

// ✅ components/.../TableColumn.tsx - 包含 JSX
export function getApprovalTableColumns() {
  return [{ render: () => <Button>...</Button> }];
}
```

### 5. 错误处理

**统一错误格式**:
```typescript
// Service 层抛出错误
throw new ValidationError("用户不存在");

// Server Action 捕获并转换
try {
  const result = await service();
  return { success: true, data: result };
} catch (error) {
  return { success: false, error: error.message };
}
```

### 6. 类型安全

**使用 Discriminated Union**:
```typescript
type Result<T> = 
  | { success: true; data: T }
  | { success: false; error: string };

// 类型守卫
if (result.success) {
  // TypeScript 知道这里是 data
  console.log(result.data);
} else {
  // TypeScript 知道这里是 error
  console.log(result.error);
}
```

## 开发规范

### 1. 命名规范
- **文件**: PascalCase（组件）、camelCase（工具函数）
- **组件**: PascalCase
- **函数**: camelCase
- **常量**: UPPER_SNAKE_CASE

### 2. 导入顺序
```typescript
// 1. React/Next.js
import { useState } from "react";
import { useRouter } from "next/navigation";

// 2. 第三方库
import { Button } from "@arco-design/web-react";

// 3. 内部模块（按层级）
import { prisma } from "@/prisma/db";
import { getApprovalRequestList } from "@/services/approval.service";
import { submitApprovalAction } from "@/actions/approval.action";
import ApprovalTableClient from "@/components/business/approval/ApprovalTableClient";
import { getStatusLabel } from "@/utils/approval";
import { APPROVAL_STATUS_OPTIONS } from "@/constants/approval";
import type { ApprovalRequestItem } from "@/types/approval";
```

### 3. 代码组织
- 每个文件只做一件事
- 保持函数简短（< 50 行）
- 使用 TypeScript 严格模式
- 避免 `any` 类型

## 数据库设计

### 核心表结构
- `users`: 用户表
- `departments`: 部门表（树形结构）
- `user_departments`: 用户-部门关联表
- `approval_requests`: 审批申请表
- `approval_attachments`: 审批附件表

### 关系设计
- 用户 ↔ 部门: 多对多关系（通过 `user_departments`）
- 用户 ↔ 审批申请: 一对多关系
- 部门 ↔ 审批申请: 多对一关系（三级部门）

## 部署说明

### 环境变量
```env
# 数据库配置
DATABASE_HOST=localhost
DATABASE_PORT=3307
DATABASE_USER=your_user
DATABASE_PASSWORD=your_password
DATABASE_NAME=your_database

# OSS 配置
OSS_REGION=your_region
OSS_ACCESS_KEY_ID=your_key
OSS_ACCESS_KEY_SECRET=your_secret
OSS_BUCKET=your_bucket
```

### 构建命令
```bash
# 开发
npm run dev

# 构建
npm run build

# 生产
npm start
```

## 总结

本项目采用现代化的 Next.js App Router 架构，通过清晰的分层设计和严格的类型系统，实现了：

1. **高性能**: Server Components 减少客户端 JavaScript
2. **类型安全**: 完整的 TypeScript 类型定义
3. **可维护性**: 清晰的文件组织和职责划分
4. **可扩展性**: 模块化设计，易于添加新功能
5. **开发体验**: 统一的错误处理、代码规范
